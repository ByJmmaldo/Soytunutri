<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriMaster - Sistema Modular</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="planes_db.js"></script>
</head>
<body class="bg-gray-100 text-slate-800 font-sans antialiased">

    <div id="error-screen" class="fixed inset-0 bg-red-50 z-50 flex items-center justify-center p-10 hidden">
        <div class="max-w-md text-center">
            <h2 class="text-2xl font-bold text-red-600 mb-2">⚠️ Error de Datos</h2>
            <p class="text-slate-600">No se ha encontrado el archivo <strong>planes_db.js</strong> o tiene errores de sintaxis.</p>
            <p class="text-xs text-slate-400 mt-4">Asegúrate de que 'planes_db.js' está en la misma carpeta que 'index.html'.</p>
        </div>
    </div>

    <div x-data="app()" x-init="initApp()" class="max-w-3xl mx-auto min-h-screen bg-white shadow-2xl flex flex-col relative z-10">
        
        <div class="bg-slate-900 text-white p-4 sticky top-0 z-40 shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-lg font-black tracking-tight italic">NUTRI<span class="text-emerald-400">MASTER</span></h1>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">
                        <span x-text="plans.length">0</span> Planes Cargados
                    </p>
                </div>
                <div class="text-right">
                    <div class="text-3xl font-black leading-none" x-text="Math.round(totals.kcal)">0</div>
                    <div class="text-[9px] font-bold text-emerald-400 uppercase tracking-widest">Kcal <span x-text="currentDay"></span></div>
                </div>
            </div>

            <select x-model="selectedPlanIdx" @change="loadPlan()" class="w-full bg-slate-800 border-none text-white text-sm rounded-lg py-3 px-4 font-bold ring-1 ring-slate-700 focus:ring-emerald-500 outline-none mb-3">
                <template x-for="(plan, index) in plans" :key="index">
                    <option :value="index" x-text="plan.nombre"></option>
                </template>
            </select>

            <div class="flex gap-1 overflow-x-auto pb-1 scrollbar-hide">
                <template x-for="day in weekDays" :key="day">
                    <button @click="setDay(day)" 
                        class="flex-1 py-2 rounded text-[10px] font-bold uppercase transition-all border"
                        :class="currentDay === day ? 'bg-emerald-500 border-emerald-500 text-white shadow' : 'bg-slate-800 border-slate-700 text-slate-400'">
                        <span x-text="day.substring(0,3)"></span>
                    </button>
                </template>
            </div>
        </div>

        <div class="flex-1 p-4 overflow-y-auto pb-24">
            
            <div class="grid grid-cols-3 gap-2 mb-6">
                <div class="bg-blue-50 p-2 rounded-lg border border-blue-100 text-center">
                    <div class="text-blue-600 font-black text-lg" x-text="Math.round(totals.p)">0</div>
                    <div class="text-[8px] text-blue-400 font-bold uppercase">Proteína</div>
                </div>
                <div class="bg-amber-50 p-2 rounded-lg border border-amber-100 text-center">
                    <div class="text-amber-600 font-black text-lg" x-text="Math.round(totals.f)">0</div>
                    <div class="text-[8px] text-amber-400 font-bold uppercase">Grasa</div>
                </div>
                <div class="bg-rose-50 p-2 rounded-lg border border-rose-100 text-center">
                    <div class="text-rose-600 font-black text-lg" x-text="Math.round(totals.c)">0</div>
                    <div class="text-[8px] text-rose-400 font-bold uppercase">Carbs</div>
                </div>
            </div>

            <div class="space-y-4">
                <template x-for="mealName in mealOrder" :key="mealName">
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden" 
                         x-show="shouldShowMeal(mealName)">
                        
                        <div class="px-4 py-2 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                            <h3 class="font-black text-slate-700 text-[10px] uppercase tracking-widest flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full" :class="getMealColor(mealName)"></span>
                                <span x-text="mealName"></span>
                            </h3>
                            <span class="text-[9px] font-bold text-slate-400" x-text="getMealKcal(dayData[mealName]) + ' kcal'"></span>
                        </div>

                        <ul class="divide-y divide-slate-50">
                            <template x-for="ing in dayData[mealName]" :key="ing.n">
                                <li class="px-4 py-2.5 flex justify-between items-center">
                                    <div>
                                        <div class="font-bold text-xs text-slate-800" x-text="ing.n"></div>
                                        <div class="flex gap-2 text-[9px] font-medium text-slate-400" x-show="db[ing.k]">
                                            <span x-text="'P:' + Math.round(calc(ing).p)"></span>
                                            <span x-text="'C:' + Math.round(calc(ing).c)"></span>
                                            <span x-text="'G:' + Math.round(calc(ing).f)"></span>
                                        </div>
                                        <div x-show="!db[ing.k]" class="text-[8px] text-red-400 font-bold bg-red-50 px-1 rounded inline-block">⚠️ Sin datos</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-black text-sm text-slate-900" x-text="ing.q"></div>
                                        <div class="text-[8px] font-bold text-slate-400 uppercase" x-text="getUnit(ing.k)"></div>
                                    </div>
                                </li>
                            </template>
                        </ul>
                    </div>
                </template>
                
                <div x-show="!hasData" class="text-center py-12 text-slate-400 text-sm">
                    <i class="fas fa-spinner fa-spin mb-2 text-2xl text-emerald-500"></i><br>
                    Cargando base de datos...
                </div>
            </div>
        </div>
    </div>

    <script>
        function app() {
            return {
                db: {},
                plans: [],
                weights: {},
                selectedPlanIdx: 0,
                currentDay: 'Lunes',
                weekDays: ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'],
                mealOrder: ['Desayuno', 'Media Mañana', 'Comida', 'Merienda', 'Cena'],
                dayData: {},
                totals: { p:0, f:0, c:0, kcal:0 },
                hasData: false,

                initApp() {
                    // Verificación de seguridad
                    if (typeof window.NUTRI_DB === 'undefined' || typeof window.NUTRI_PLANS === 'undefined') {
                        document.getElementById('error-screen').classList.remove('hidden');
                        return;
                    }

                    // Carga de datos externos
                    this.db = window.NUTRI_DB;
                    this.plans = window.NUTRI_PLANS;
                    this.weights = window.NUTRI_WEIGHTS;

                    // Seleccionar último plan
                    if (this.plans.length > 0) this.selectedPlanIdx = this.plans.length - 1;
                    
                    this.loadPlan();
                },

                loadPlan() {
                    const plan = this.plans[this.selectedPlanIdx];
                    if (!plan) return;

                    let rawData = plan.dias[this.currentDay];
                    // Si el día está vacío, usar un fallback vacío pero seguro
                    if (!rawData) rawData = {}; 

                    this.dayData = JSON.parse(JSON.stringify(rawData));
                    this.hasData = true;
                    this.calculateTotals();
                },

                setDay(day) {
                    this.currentDay = day;
                    this.loadPlan();
                },

                shouldShowMeal(mealName) {
                    return this.dayData[mealName] && this.dayData[mealName].length > 0;
                },

                calc(ing) {
                    const item = this.db[ing.k];
                    if (!item) return { p:0, f:0, c:0, kcal:0 };
                    
                    let grams = ing.q;
                    // Conversión inteligente de unidades
                    if (this.weights[ing.k] && ing.q < 10) {
                        grams = ing.q * this.weights[ing.k];
                    }

                    return {
                        p: (item.p * grams) / 100,
                        f: (item.f * grams) / 100,
                        c: (item.c * grams) / 100,
                        kcal: (item.k * grams) / 100
                    };
                },

                getMealKcal(ingredients) {
                    if (!ingredients) return 0;
                    return Math.round(ingredients.reduce((acc, curr) => acc + this.calc(curr).kcal, 0));
                },

                calculateTotals() {
                    this.totals = { p:0, f:0, c:0, kcal:0 };
                    this.mealOrder.forEach(meal => {
                        if (this.dayData[meal]) {
                            this.dayData[meal].forEach(ing => {
                                const m = this.calc(ing);
                                this.totals.p += m.p;
                                this.totals.f += m.f;
                                this.totals.c += m.c;
                                this.totals.kcal += m.kcal;
                            });
                        }
                    });
                },

                getUnit(k) {
                    if (['leche','cafe','caldo'].includes(k)) return 'ml';
                    if (this.weights[k]) return 'ud';
                    return 'g';
                },

                getMealColor(name) {
                    const n = name.toLowerCase();
                    if(n.includes('desayuno')) return 'bg-amber-400';
                    if(n.includes('media')) return 'bg-orange-300';
                    if(n.includes('comida')) return 'bg-emerald-500';
                    if(n.includes('merienda')) return 'bg-purple-400';
                    if(n.includes('cena')) return 'bg-indigo-500';
                    return 'bg-gray-300';
                }
            }
        }
    </script>
</body>
</html>