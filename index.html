<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>MaldoFit Elite</title>
    <style>
        :root {
            --bg: #050505; --card: #111; --border: #222; --text: #fff; --sub: #888;
            --main: #00f2ff; /* Neon Blue */
            --accent: #bc13fe; /* Neon Purple */
            --ok: #0aff60; --bad: #ff2a6d; --warn: #ffd500;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 0 0 90px 0; height: 100vh; overflow-y: auto; }
        
        /* HEADER & TABS */
        .head { position: sticky; top: 0; background: rgba(5,5,5,0.95); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); padding: 15px; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-weight: 900; font-size: 20px; letter-spacing: -0.5px; background: linear-gradient(45deg, var(--main), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn-ghost { border: 1px solid var(--main); color: var(--main); background: 0 0; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; cursor: pointer; }
        
        .tabs { display: flex; overflow-x: auto; gap: 8px; padding: 15px; scrollbar-width: none; }
        .tab { background: var(--card); border: 1px solid var(--border); color: var(--sub); padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; white-space: nowrap; cursor: pointer; transition: 0.2s; }
        .tab.active { background: var(--main); color: #000; border-color: var(--main); box-shadow: 0 0 10px rgba(0,242,255,0.3); }

        /* DASHBOARD */
        .dash { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 0 15px 20px; }
        .stat { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 10px 4px; text-align: center; }
        .val { display: block; font-size: 13px; font-weight: 800; color: #fff; }
        .lbl { font-size: 9px; color: var(--sub); text-transform: uppercase; margin-top: 3px; }
        .bar { height: 3px; background: #333; margin-top: 6px; border-radius: 2px; overflow: hidden; }
        .fill { height: 100%; width: 0%; transition: 0.3s ease; }

        /* LISTS */
        .list { padding: 0 15px; }
        .item { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 15px; margin-bottom: 10px; position: relative; }
        .i-cat { font-size: 10px; font-weight: 800; color: var(--accent); text-transform: uppercase; margin-bottom: 5px; }
        .i-name { font-size: 15px; font-weight: 600; margin-bottom: 5px; padding-right: 30px; line-height: 1.3; }
        .i-meta { font-size: 11px; color: var(--sub); font-family: monospace; }
        .i-ing { font-size: 12px; color: #666; margin-top: 8px; padding-top: 8px; border-top: 1px solid #222; line-height: 1.4; }
        
        .act-btn { position: absolute; top: 12px; right: 12px; width: 28px; height: 28px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; cursor: pointer; }
        .add { background: var(--ok); color: #000; }
        .del { background: 0 0; color: var(--bad); font-size: 22px; top: 10px; right: 10px; }

        /* SEARCH & LIB */
        .search-wrap { position: sticky; top: 62px; background: var(--bg); z-index: 90; padding: 10px 15px; border-bottom: 1px solid #111; }
        .inp-search { width: 100%; background: #1a1a1a; border: 1px solid var(--border); padding: 12px; border-radius: 10px; color: #fff; font-size: 15px; outline: none; }
        .chips { display: flex; gap: 8px; overflow-x: auto; padding-top: 10px; padding-bottom: 5px; scrollbar-width: none; }
        .chip { padding: 6px 12px; background: #222; border-radius: 15px; font-size: 11px; color: #aaa; white-space: nowrap; cursor: pointer; border: 1px solid transparent; }
        .chip.active { background: var(--accent); color: #fff; }

        /* MODAL */
        #modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; align-items: center; justify-content: center; }
        .m-content { background: #111; width: 90%; max-width: 450px; padding: 25px; border-radius: 20px; border: 1px solid var(--border); max-height: 90vh; overflow-y: auto; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .f-lbl { display: block; font-size: 10px; color: var(--sub); text-transform: uppercase; font-weight: 700; margin-bottom: 5px; }
        .f-inp { width: 100%; background: #000; border: 1px solid var(--border); color: #fff; padding: 12px; border-radius: 8px; font-size: 15px; outline: none; }
        .btn-full { width: 100%; background: var(--main); color: #000; padding: 14px; border-radius: 10px; border: none; font-weight: 800; text-transform: uppercase; margin-top: 10px; cursor: pointer; }
        
        .grid-wk { display: grid; gap: 8px; margin-top: 20px; }
        .wk-row { display: grid; grid-template-columns: 40px 1fr 1fr 1fr 1fr; gap: 5px; align-items: center; }
        .wk-lbl { font-size: 11px; font-weight: 700; color: var(--sub); }
        .wk-inp { width: 100%; background: #222; border: none; color: #fff; padding: 8px 4px; text-align: center; border-radius: 4px; font-size: 12px; }

        /* NAV */
        .nav { position: fixed; bottom: 0; width: 100%; background: rgba(10,10,10,0.95); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 10px 0 25px; z-index: 1000; backdrop-filter: blur(10px); }
        .n-btn { background: 0 0; border: none; color: #555; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; font-weight: 600; cursor: pointer; }
        .n-btn.active { color: var(--main); } .icon { font-size: 20px; }

        .view { display: none; } .view.active { display: block; }
        @media print { .nav, .header, .tabs, .search-wrap, .act-btn { display: none!important; } .view { display: block!important; } body { background: #fff; color: #000; } .item { border: 1px solid #ccc; background: #fff; color: #000; break-inside: avoid; } }
    </style>
</head>
<body>

<div id="v-home" class="view active">
    <div class="head"><div class="logo">MaldoFit</div><button class="btn-ghost" onclick="toggleModal(true)">OBJETIVOS</button></div>
    <div class="tabs" id="day-tabs"></div>
    <div class="dash">
        <div class="stat"><span class="val" id="dk">0</span><span class="lbl">Kcal</span><div class="bar"><div id="bk" class="fill" style="background:#fff"></div></div></div>
        <div class="stat"><span class="val" id="dp">0</span><span class="lbl">Prot</span><div class="bar"><div id="bp" class="fill" style="background:var(--bad)"></div></div></div>
        <div class="stat"><span class="val" id="dc">0</span><span class="lbl">Carb</span><div class="bar"><div id="bc" class="fill" style="background:var(--warn)"></div></div></div>
        <div class="stat"><span class="val" id="df">0</span><span class="lbl">Grasa</span><div class="bar"><div id="bf" class="fill" style="background:var(--ok)"></div></div></div>
    </div>
    <div id="plan-list" class="list"></div>
</div>

<div id="v-lib" class="view">
    <div class="head"><h1>Alimentos</h1></div>
    <div class="search-wrap">
        <input type="text" id="search" class="inp-search" placeholder="Buscar..." onkeyup="renderLib()">
        <div class="chips" id="cat-filters"></div>
    </div>
    <div id="lib-list" class="list" style="padding-bottom: 100px;"></div>
</div>

<div id="modal" class="modal">
    <div class="m-box">
        <h2 style="color:var(--main);margin-top:0">Perfil & Objetivos</h2>
        <div class="form-row">
            <div><label class="f-lbl">Peso</label><input type="number" id="w" class="f-inp" value="80"></div>
            <div><label class="f-lbl">Altura</label><input type="number" id="h" class="f-inp" value="180"></div>
        </div>
        <div class="form-row">
            <div><label class="f-lbl">Edad</label><input type="number" id="a" class="f-inp" value="30"></div>
            <div><label class="f-lbl">Sexo</label><select id="s" class="f-inp"><option value="m">H</option><option value="f">M</option></select></div>
        </div>
        <div style="margin-bottom:15px"><label class="f-lbl">Actividad</label><select id="act" class="f-inp"><option value="1.2">Sedentario</option><option value="1.375">Ligero</option><option value="1.55" selected>CrossFit (3-5d)</option><option value="1.725">Alto</option></select></div>
        <div style="margin-bottom:15px"><label class="f-lbl">Objetivo Global</label><select id="goal" class="f-inp" style="border-color:var(--accent)"><option value="-0.2">Definici√≥n Agresiva (-20%)</option><option value="-0.1">Definici√≥n (-10%)</option><option value="0">Mantenimiento</option><option value="0.1">Volumen Limpio (+10%)</option><option value="0.2">Volumen Agresivo (+20%)</option></select></div>
        <button class="btn-full" onclick="calcBase()">Auto-Calcular Todo</button>
        
        <div style="margin-top:20px;border-top:1px solid #333;padding-top:10px;">
            <label class="f-lbl" style="color:#fff;margin-bottom:10px">Ajuste Manual por D√≠a</label>
            <div id="grid-wk" class="grid-wk"></div>
        </div>
        
        <button class="btn-full" style="background:#333;margin-top:20px" onclick="saveConfig()">Guardar Cambios</button>
        <button onclick="toggleModal(false)" style="width:100%;padding:15px;background:0 0;border:none;color:#666;margin-top:5px">Cancelar</button>
    </div>
</div>

<div class="nav">
    <button class="n-btn active" onclick="go('v-home',this)"><span class="icon">üìÖ</span>Plan</button>
    <button class="n-btn" onclick="go('v-lib',this)"><span class="icon">üçî</span>Alimentos</button>
    <button class="n-btn" onclick="window.print()"><span class="icon">üñ®Ô∏è</span>PDF</button>
</div>

<script src="data.js"></script>

<script>
// STATE
let state = { day:'Lunes', cat:'Desayuno', plan:{}, targets:{} };
const DAYS = ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"];
const CATS = ["Desayuno","Tentempi√©","Comida","Merienda","Cena"];

// INIT
window.onload = () => {
    // Si foodDB no carga, avisar
    if(typeof foodDB === 'undefined') { alert("Error: Falta el archivo data.js"); return; }
    
    // Init Plan Structure
    DAYS.forEach(d => { if(!state.plan[d]) state.plan[d] = []; });

    // Load LocalStorage
    try {
        const t = localStorage.getItem('mf_targets_v3');
        const p = localStorage.getItem('mf_plan_v3');
        if(t) state.targets = JSON.parse(t); else calcBase(true);
        if(p) state.plan = JSON.parse(p);
    } catch(e) { calcBase(true); }

    renderTabs();
    renderCats();
    renderPlan();
    renderLib();
};

// LOGIC
function calcBase(silent) {
    const w=parseFloat(document.getElementById('w').value)||80, h=parseFloat(document.getElementById('h').value)||180, a=parseFloat(document.getElementById('a').value)||30, s=document.getElementById('s').value||'m', act=parseFloat(document.getElementById('act').value)||1.55, goal=parseFloat(document.getElementById('goal').value)||0;
    
    let bmr = (s==='m') ? 88.362+(13.397*w)+(4.799*h)-(5.677*a) : 447.593+(9.247*w)+(3.098*h)-(4.330*a);
    const k=Math.round(bmr*act*(1+goal)), p=Math.round(w*2), f=Math.round(w*0.9), c=Math.round((k-p*4-f*9)/4);
    
    DAYS.forEach(d => state.targets[d] = {k,p,c,f});
    if(!silent) renderGrid();
}

function renderGrid() {
    const g = document.getElementById('grid-wk'); g.innerHTML = '';
    // Header
    g.innerHTML += `<div class="wk-row"><span class="wk-lbl"></span><span class="wk-lbl" style="color:#fff">KCAL</span><span class="wk-lbl" style="color:var(--bad)">PRO</span><span class="wk-lbl" style="color:var(--warn)">CAR</span><span class="wk-lbl" style="color:var(--ok)">GRA</span></div>`;
    DAYS.forEach(d => {
        const t = state.targets[d];
        g.innerHTML += `<div class="wk-row"><span class="wk-lbl">${d.substr(0,3)}</span><input type="number" id="k_${d}" value="${t.k}" class="wk-inp"><input type="number" id="p_${d}" value="${t.p}" class="wk-inp" style="color:var(--bad)"><input type="number" id="c_${d}" value="${t.c}" class="wk-inp" style="color:var(--warn)"><input type="number" id="f_${d}" value="${t.f}" class="wk-inp" style="color:var(--ok)"></div>`;
    });
}

function saveConfig() {
    DAYS.forEach(d => {
        state.targets[d] = {
            k: parseInt(document.getElementById(`k_${d}`).value),
            p: parseInt(document.getElementById(`p_${d}`).value),
            c: parseInt(document.getElementById(`c_${d}`).value),
            f: parseInt(document.getElementById(`f_${d}`).value)
        };
    });
    localStorage.setItem('mf_targets_v3', JSON.stringify(state.targets));
    toggleModal(false);
    renderPlan();
}

// UI
function renderTabs() {
    const c = document.getElementById('day-tabs'); c.innerHTML='';
    DAYS.forEach(d => c.innerHTML += `<div class="tab ${state.day===d?'active':''}" onclick="setDay('${d}')">${d}</div>`);
}
function renderCats() {
    const c = document.getElementById('cat-filters'); c.innerHTML='';
    CATS.forEach(cat => c.innerHTML += `<div class="chip ${state.cat===cat?'active':''}" onclick="setCat('${cat}')">${cat}</div>`);
}

function setDay(d) { state.day=d; renderTabs(); renderPlan(); }
function setCat(c) { state.cat=c; renderCats(); renderLib(); }
function toggleModal(s) { document.getElementById('modal').style.display = s?'flex':'none'; if(s) renderGrid(); }
function go(v,btn) { 
    document.querySelectorAll('.view').forEach(x=>x.classList.add('hide'));
    document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));
    document.getElementById(v).classList.remove('hide');
    document.getElementById(v).classList.add('active');
    document.querySelectorAll('.n-item').forEach(x=>x.classList.remove('active'));
    btn.classList.add('active');
}

function renderLib() {
    const list = document.getElementById('lib-list'), term = document.getElementById('search').value.toLowerCase();
    list.innerHTML = '';
    const filtered = foodDB.filter(x => {
        let m = x.t === state.cat;
        if(state.cat==='Tentempi√©' && (x.t.includes('Ma√±ana')||x.t.includes('M.MA√ëANA'))) m=true;
        return m && (x.n.toLowerCase().includes(term) || x.d.toLowerCase().includes(term));
    });
    
    filtered.forEach(x => {
        list.innerHTML += `<div class="item"><div class="i-cat">${x.t}</div><div class="i-name">${x.n}</div><div class="i-det">üî•${x.k} P${x.p} C${x.c} F${x.f}</div><div class="i-ing">${x.d}</div><button class="act add" onclick="add(${x.i})">+</button></div>`;
    });
}

function renderPlan() {
    const list = document.getElementById('plan-list'); list.innerHTML = '';
    let tot = {k:0,p:0,c:0,f:0};
    (state.plan[state.day]||[]).forEach((x, idx) => {
        tot.k+=x.k; tot.p+=x.p; tot.c+=x.c; tot.f+=x.f;
        list.innerHTML += `<div class="item"><div class="i-cat">${x.t}</div><div class="i-name">${x.n}</div><div class="i-det">üî•${x.k} P${x.p} C${x.c} F${x.f}</div><button class="act del" onclick="del(${idx})">√ó</button></div>`;
    });
    
    const t = state.targets[state.day] || {k:2500,p:160,c:300,f:70};
    updBar('k', tot.k, t.k); updBar('p', tot.p, t.p); updBar('c', tot.c, t.c); updBar('f', tot.f, t.f);
    localStorage.setItem('mf_plan_v3', JSON.stringify(state.plan));
}

function updBar(k, v, max) {
    document.getElementById('d'+k).innerText = `${v} / ${max}`;
    document.getElementById('b'+k).style.width = Math.min((v/max)*100, 100) + '%';
}

function add(id) { state.plan[state.day].push(foodDB.find(x=>x.i===id)); renderPlan(); }
function del(idx) { state.plan[state.day].splice(idx,1); renderPlan(); }
</script>
</body>
</html>
